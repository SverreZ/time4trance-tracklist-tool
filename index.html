<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<title>Time4Trance Tracklist Tool - Dynamische Kolommen</title>
<style>
  body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 0 15px; }
  textarea { width: 100%; height: 200px; margin-top: 10px; font-family: monospace; }
  select, button { padding: 10px 15px; margin-top: 15px; font-size: 1rem; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  input[type=text] { width: 100%; padding: 6px; box-sizing: border-box; }
  pre { background: #f7f7f7; border: 1px solid #ccc; padding: 15px; white-space: pre-wrap; min-height: 150px; margin-top: 20px; }
</style>
</head>
<body>

<h2>Time4Trance Tracklist Tool</h2>

<textarea id="input" placeholder="Plak hier je Rekordbox-export..."></textarea>
<br />
<button id="loadBtn">Tracklist inladen</button>

<div id="tracks-container"></div>

<button id="exportBtn" style="display:none;">Exporteer</button>

<h3>Tracklist output:</h3>
<pre id="output"></pre>

<script>
  let tracks = [];

  const loadBtn = document.getElementById('loadBtn');
  const exportBtn = document.getElementById('exportBtn');
  const container = document.getElementById('tracks-container');
  const output = document.getElementById('output');

  function findColumnIndices(headerFields) {
    const lowered = headerFields.map(h => h.toLowerCase());
    return {
      artistIdx: lowered.findIndex(h => h.includes('artist')),
      titleIdx: lowered.findIndex(h => h.includes('titel') || h.includes('title')),
      labelIdx: lowered.findIndex(h => h.includes('label')),
    };
  }

  loadBtn.addEventListener('click', () => {
    const input = document.getElementById('input').value.trim();
    if (!input) {
      alert('Plak eerst je Rekordbox-export in het invoerveld.');
      return;
    }
    output.textContent = '';
    container.innerHTML = '';
    exportBtn.style.display = 'none';
    tracks = [];

    const lines = input.split(/\r?\n/);
    let headerLine = -1;
    for (let i = 0; i < lines.length; i++) {
      // header: zoek rij met 'titel' of 'title' en 'artist'
      const low = lines[i].toLowerCase();
      if (low.includes('titel') && low.includes('artist') || low.includes('title') && low.includes('artist')) {
        headerLine = i;
        break;
      }
    }
    if (headerLine === -1) {
      alert('Headerregel met kolomnamen niet gevonden. Zorg dat je de volledige Rekordbox-export plakt.');
      return;
    }

    // Header parsen op tabs of spaties
    const delimiter = lines[headerLine].includes('\t') ? '\t' : / {2,}/;
    const headers = lines[headerLine].split(delimiter).map(h => h.trim());
    const { artistIdx, titleIdx, labelIdx } = findColumnIndices(headers);

    if (artistIdx === -1 || titleIdx === -1) {
      alert('Kon kolommen Artist en Title niet correct vinden in header.');
      return;
    }

    for (let i = headerLine + 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const fields = lines[i].split(delimiter).map(f => f.trim());
      if (fields.length <= Math.max(artistIdx, titleIdx)) continue;

      let artist = fields[artistIdx] || '';
      let title = fields[titleIdx] || '';
      let label = (labelIdx !== -1 && fields[labelIdx]) ? fields[labelIdx] : '';

      // fallback split: als artist leeg of UNKNOWN en titel bevat ' - '
      if ((!artist || artist.toUpperCase() === 'UNKNOWN' || artist === '') && title.includes(' - ')) {
        const splitPos = title.indexOf(' - ');
        artist = title.substring(0, splitPos).trim() || 'UNKNOWN';
        title = title.substring(splitPos + 3).trim() || 'UNKNOWN';
      }

      if (!artist) artist = 'UNKNOWN';
      if (!title) title = 'UNKNOWN';
      if (!label) label = 'UNKNOWN';

      tracks.push({ artist, title, label });
    }

    // Tabel maken met bewerkbare velden
    let html = '<table><thead><tr><th>#</th><th>Artiest</th><th>Titel</th><th>Label</th></tr></thead><tbody>';
    tracks.forEach((t, i) => {
      html += `<tr>
        <td>${i + 1}</td>
        <td><input type="text" data-field="artist" data-index="${i}" value="${t.artist}"></td>
        <td><input type="text" data-field="title" data-index="${i}" value="${t.title}"></td>
        <td><input type="text" data-field="label" data-index="${i}" value="${t.label}"></td>
      </tr>`;
    });
    html += '</tbody></table>';

    container.innerHTML = html;
    exportBtn.style.display = 'inline-block';
    output.textContent = '';

    container.querySelectorAll('input[type=text]').forEach(input => {
      input.addEventListener('input', e => {
        const idx = e.target.getAttribute('data-index');
        const field = e.target.getAttribute('data-field');
        tracks[idx][field] = e.target.value.trim();
      });
    });
  });

  exportBtn.addEventListener('click', () => {
    const formatted = tracks.map((t, i) => {
      const label = t.label.trim() ? t.label : 'UNKNOWN';
      return `${i + 1}. ${t.artist} - ${t.title} [${label}]`;
    });
    output.textContent = formatted.join('\n');
  });
</script>

</body>
</html>
